<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Narrative Detector</title>
    <style>
        :root {
            --bg: #0a0b0f;
            --surface: #12131a;
            --surface2: #1a1b25;
            --border: #2a2b3a;
            --text: #e4e4ed;
            --text-dim: #8888a0;
            --accent: #9945FF;
            --accent2: #14F195;
            --gradient: linear-gradient(135deg, #9945FF, #14F195);
            --red: #ff4d6a;
            --green: #14F195;
            --yellow: #ffd93d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        header {
            padding: 40px 0 30px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        header h1 {
            font-size: 2rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        header .subtitle { color: var(--text-dim); font-size: 0.95rem; }
        .meta-row {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .meta-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 0.85rem;
        }
        .meta-item .label { color: var(--text-dim); margin-bottom: 4px; }
        .meta-item .value { font-weight: 600; font-size: 1.1rem; }

        section { margin-bottom: 40px; }
        section h2 {
            font-size: 1.3rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        section h2 .badge {
            background: var(--gradient);
            color: #000;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 700;
        }

        .narrative-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }
        .narrative-card:hover { border-color: var(--accent); }
        .narrative-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .narrative-title { font-size: 1.15rem; font-weight: 600; }
        .narrative-score {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 12px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .narrative-score.high { color: var(--green); border-color: var(--green); }
        .narrative-score.medium { color: var(--yellow); border-color: var(--yellow); }
        .narrative-score.low { color: var(--text-dim); }
        .signal-list { margin-top: 12px; }
        .signal-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.88rem;
            color: var(--text-dim);
        }
        .signal-source {
            background: var(--surface2);
            border-radius: 4px;
            padding: 1px 6px;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            flex-shrink: 0;
        }
        .signal-source.github { color: var(--accent); }
        .signal-source.onchain, .signal-source.defi { color: var(--accent2); }
        .signal-source.market { color: var(--yellow); }

        .idea-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
        }
        .idea-card:hover { border-color: var(--accent2); }
        .idea-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent2);
            margin-bottom: 8px;
        }
        .idea-narrative {
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 10px;
            background: var(--surface2);
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .idea-description { font-size: 0.9rem; color: var(--text-dim); margin-bottom: 12px; }
        .idea-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .idea-meta-item {
            background: var(--surface2);
            border-radius: 6px;
            padding: 10px 14px;
        }
        .idea-meta-item .label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .idea-meta-item .value { font-size: 0.85rem; }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 16px;
        }
        .data-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .data-panel h3 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--text);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th {
            text-align: left;
            color: var(--text-dim);
            font-weight: 600;
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
        }
        .positive { color: var(--green); }
        .negative { color: var(--red); }

        .refresh-btn {
            background: var(--gradient);
            color: #000;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .refresh-btn:hover { opacity: 0.9; }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        footer {
            border-top: 1px solid var(--border);
            padding: 20px 0;
            color: var(--text-dim);
            font-size: 0.8rem;
            text-align: center;
        }
        footer a { color: var(--accent); text-decoration: none; }

        @media (max-width: 768px) {
            .container { padding: 12px; }
            header h1 { font-size: 1.5rem; }
            .meta-row { gap: 10px; }
            .data-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Solana Narrative Detector</h1>
            <p class="subtitle">AI-powered detection of emerging narratives and build ideas in the Solana ecosystem — refreshed fortnightly</p>
            <div class="meta-row">
                <div class="meta-item">
                    <div class="label">Generated</div>
                    <div class="value" id="gen-time">{{ data.generated_at[:16] }}Z</div>
                </div>
                <div class="meta-item">
                    <div class="label">Analysis Period</div>
                    <div class="value">{{ data.period }}</div>
                </div>
                <div class="meta-item">
                    <div class="label">Solana TVL</div>
                    <div class="value">
                        {% if data.data_sources.onchain.tvl_current %}
                            ${{ "%.2f"|format(data.data_sources.onchain.tvl_current / 1000000000) }}B
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                </div>
                <div class="meta-item">
                    <div class="label">Avg TPS</div>
                    <div class="value">{{ data.data_sources.onchain.avg_tps or "N/A" }}</div>
                </div>
                <div class="meta-item">
                    <div class="label">Repos Tracked</div>
                    <div class="value">{{ data.data_sources.github.repos_tracked }}</div>
                </div>
                <div class="meta-item">
                    <button class="refresh-btn" onclick="refreshData()">Refresh Data</button>
                </div>
            </div>
        </header>

        <!-- DETECTED NARRATIVES -->
        <section>
            <h2>Detected Narratives <span class="badge">{{ data.narratives|length }} found</span></h2>
            {% for n in data.narratives %}
            <div class="narrative-card">
                <div class="narrative-header">
                    <div class="narrative-title">{{ loop.index }}. {{ n.narrative }}</div>
                    <div class="narrative-score {% if n.score > 50 %}high{% elif n.score > 20 %}medium{% else %}low{% endif %}">
                        Score: {{ n.score }}
                    </div>
                </div>
                <div style="color: var(--text-dim); font-size: 0.88rem;">
                    {{ n.signal_count }} signal{{ "s" if n.signal_count != 1 else "" }} from {{ n.sources|join(", ") }}
                </div>
                <div class="signal-list">
                    {% for s in n.signals %}
                    <div class="signal-item">
                        <span class="signal-source {{ s.source }}">{{ s.source }}</span>
                        <span><strong>{{ s.signal }}</strong> — {{ s.evidence }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </section>

        <!-- BUILD IDEAS -->
        <section>
            <h2>Build Ideas <span class="badge">{{ data.build_ideas|length }} ideas</span></h2>
            {% for idea in data.build_ideas %}
            <div class="idea-card">
                <div class="idea-narrative">{{ idea.tied_narrative }}</div>
                <div class="idea-title">{{ loop.index }}. {{ idea.title }}</div>
                <div class="idea-description">{{ idea.description }}</div>
                <div class="idea-meta">
                    <div class="idea-meta-item">
                        <div class="label">Target Users</div>
                        <div class="value">{{ idea.target_users }}</div>
                    </div>
                    <div class="idea-meta-item">
                        <div class="label">Solana Integration</div>
                        <div class="value">{{ idea.solana_integration }}</div>
                    </div>
                    <div class="idea-meta-item">
                        <div class="label">Complexity</div>
                        <div class="value">{{ idea.complexity }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </section>

        <!-- RAW DATA PANELS -->
        <section>
            <h2>Supporting Data</h2>
            <div class="data-grid">
                <!-- Most Active Repos -->
                <div class="data-panel">
                    <h3>Most Active Solana Repos (14d)</h3>
                    <table>
                        <tr><th>Repo</th><th>Commits</th><th>Stars</th></tr>
                        {% for r in data.github_data.most_active_repos[:8] %}
                        <tr>
                            <td>{{ r.repo }}</td>
                            <td>{{ r.recent_commits }}</td>
                            <td>{{ r.stars }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>

                <!-- Top Protocols -->
                <div class="data-panel">
                    <h3>Top Solana Protocols by TVL</h3>
                    <table>
                        <tr><th>Protocol</th><th>TVL</th><th>7d Change</th></tr>
                        {% for p in data.onchain_data.top_protocols[:8] %}
                        <tr>
                            <td>{{ p.name }}</td>
                            <td>${{ "%.0f"|format(p.tvl_usd / 1000000) }}M</td>
                            <td class="{% if p.change_7d_pct > 0 %}positive{% elif p.change_7d_pct < 0 %}negative{% endif %}">
                                {{ "%+.1f"|format(p.change_7d_pct) }}%
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>

                <!-- TVL Trend -->
                <div class="data-panel">
                    <h3>Solana TVL (14-day trend)</h3>
                    {% if data.onchain_data.tvl.daily_tvl %}
                    <div style="display:flex;align-items:flex-end;gap:4px;height:120px;margin-top:10px;">
                        {% set ns = namespace(max_tvl=0) %}
                        {% for d in data.onchain_data.tvl.daily_tvl %}
                            {% if d.tvl > ns.max_tvl %}{% set ns.max_tvl = d.tvl %}{% endif %}
                        {% endfor %}
                        {% for d in data.onchain_data.tvl.daily_tvl %}
                        <div style="flex:1;background:var(--accent);border-radius:3px 3px 0 0;height:{{ (d.tvl / ns.max_tvl * 100)|int }}%;min-width:8px;" title="{{ d.date }}: ${{ '%.2f'|format(d.tvl / 1000000000) }}B"></div>
                        {% endfor %}
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-dim);margin-top:4px;">
                        <span>{{ data.onchain_data.tvl.daily_tvl[0].date }}</span>
                        <span>{{ data.onchain_data.tvl.daily_tvl[-1].date }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Stablecoins -->
                <div class="data-panel">
                    <h3>Stablecoins on Solana</h3>
                    {% if data.onchain_data.stablecoins.total_stablecoin_mcap_solana %}
                    <div style="font-size:1.3rem;font-weight:700;color:var(--accent2);margin-bottom:12px;">
                        ${{ "%.2f"|format(data.onchain_data.stablecoins.total_stablecoin_mcap_solana / 1000000000) }}B total
                    </div>
                    {% endif %}
                    <table>
                        <tr><th>Stablecoin</th><th>Market Cap (Solana)</th></tr>
                        {% for s in data.onchain_data.stablecoins.get("top_stablecoins", [])[:6] %}
                        <tr>
                            <td>{{ s.name }} ({{ s.symbol }})</td>
                            <td>${{ "%.0f"|format(s.solana_mcap_usd / 1000000) }}M</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>

                <!-- Network Stats -->
                <div class="data-panel">
                    <h3>Network Stats</h3>
                    <table>
                        <tr><td>Average TPS</td><td>{{ data.onchain_data.network_performance.get("avg_tps", "N/A") }}</td></tr>
                        <tr><td>Total SOL Supply</td><td>{{ "%.0f"|format(data.onchain_data.supply.get("total_sol", 0)) }}M</td></tr>
                        <tr><td>Circulating SOL</td><td>{{ "%.0f"|format(data.onchain_data.supply.get("circulating_sol", 0)) }}M</td></tr>
                        {% if data.onchain_data.tvl.tvl_change_14d_pct is defined %}
                        <tr>
                            <td>TVL 14d Change</td>
                            <td class="{% if data.onchain_data.tvl.tvl_change_14d_pct > 0 %}positive{% else %}negative{% endif %}">
                                {{ "%+.1f"|format(data.onchain_data.tvl.tvl_change_14d_pct) }}%
                            </td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </section>

        <footer>
            <p>Solana Narrative Detector v1.0.0 — Built by an autonomous AI agent</p>
            <p>Data sources: <a href="https://github.com">GitHub API</a> | <a href="https://defillama.com">DeFiLlama</a> | <a href="https://solana.com">Solana RPC</a></p>
            <p style="margin-top:8px;">API endpoints: <code>/api/narratives</code> | <code>/api/signals</code> | <code>/api/refresh</code></p>
        </footer>
    </div>

    <script>
        async function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            btn.disabled = true;
            btn.textContent = 'Refreshing...';
            try {
                await fetch('/api/refresh');
                window.location.reload();
            } catch (e) {
                btn.textContent = 'Error — retry';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
